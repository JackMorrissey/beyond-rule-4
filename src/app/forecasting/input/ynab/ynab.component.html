<div class="alert alert-dark fw-bold" *ngIf="isUsingSampleData">
  <fa-icon [icon]="['fas', 'info-circle']"></fa-icon>
  Using Sample Data
</div>

<form [formGroup]="budgetForm" class="budgetForm">
  <div ngbAccordion [closeOthers]="false">
    <div ngbAccordionItem id="pSettings">
      <h2 ngbAccordionHeader>
        <button ngbAccordionButton>
          <span class="float-start">Settings</span>
          <div class="ms-auto"></div>
        </button>
      </h2>
      <div ngbAccordionCollapse>
        <div ngbAccordionBody>
          <ng-template>
            <div class="form-group">
              <div class="row mb-3">
                <label
                  for="selectedBudget"
                  class="col-sm-12 col-md-5 col-form-label"
                  >Budget</label
                >
                <div class="col">
                  <div class="input-group">
                    <select
                      class="form-control"
                      id="selectedBudget"
                      formControlName="selectedBudget"
                    >
                      <option
                        *ngFor="let budget of budgets"
                        [value]="budget.id"
                      >
                        {{ budget.name }}
                      </option>
                    </select>
                    <button
                      type="button"
                      class="btn btn-outline-secondary"
                      (click)="reloadBudget()"
                      [disabled]="isReloadingBudget || !budget"
                      ngbTooltip="Reload budget and reset adjustments"
                      placement="top"
                    >
                      <fa-icon
                        [icon]="['fas', 'sync']"
                        [animation]="isReloadingBudget ? 'spin' : undefined"
                      ></fa-icon>
                    </button>
                  </div>
                </div>
              </div>
            </div>
            <div class="form-group">
              <div class="row mb-1">
                <label
                  for="selectedBudget"
                  class="col-sm-12 col-md-5 col-form-label"
                  >Month Start</label
                >
                <div class="col">
                  <div class="input-group">
                    <select
                      class="form-control"
                      id="selectedMonthA"
                      formControlName="selectedMonthA"
                    >
                      <option
                        *ngFor="let month of months"
                        [value]="month.month"
                      >
                        {{ month.month }}
                      </option>
                    </select>
                  </div>
                </div>
              </div>
              <div class="row mb-1">
                <label
                  for="selectedBudget"
                  class="col-sm-12 col-md-5 col-form-label"
                  >Month End</label
                >
                <div class="col">
                  <div class="input-group">
                    <select
                      class="form-control"
                      id="selectedMonthB"
                      formControlName="selectedMonthB"
                    >
                      <option
                        *ngFor="let month of months"
                        [value]="month.month"
                      >
                        {{ month.month }}
                      </option>
                    </select>
                  </div>
                </div>
              </div>

              <div class="row mb-1">
                <label
                  for="selectedBudget"
                  class="col-sm-12 col-md-5 col-form-label"
                ></label>
                <div class="col">
                  <div ngbDropdown class="input-group d-inline-block">
                    <button
                      class="btn btn-outline-secondary btn-sm w-100"
                      id="quickSelectMonths"
                      ngbDropdownToggle
                    >
                      Quick Choose
                    </button>
                    <div ngbDropdownMenu aria-labelledby="quickSelectMonths">
                      <button
                        ngbDropdownItem
                        (click)="quickChooseMonths('allTrim')"
                      >
                        All Complete
                      </button>
                      <button
                        ngbDropdownItem
                        (click)="quickChooseMonths('all')"
                      >
                        All
                      </button>

                      <button ngbDropdownItem (click)="quickChooseMonths('yr')">
                        Last Year
                      </button>
                      <button ngbDropdownItem (click)="quickChooseMonths('12')">
                        Last 12 Months
                      </button>
                      <button
                        ngbDropdownItem
                        (click)="quickChooseMonths('ytd')"
                      >
                        YTD
                      </button>
                      <button
                        ngbDropdownItem
                        (click)="quickChooseMonths('curr')"
                      >
                        Current Month
                      </button>
                    </div>
                  </div>
                </div>
              </div>

              <div class="row mb-3">
                <div class="col">
                  <small
                    >The month range to use for average contributions and
                    expenses
                  </small>
                </div>
              </div>
            </div>
            <div class="form-group">
              <div class="row">
                <label
                  for="safeWithdrawalRatePercentage"
                  class="col-sm-12 col-md-5 col-form-label"
                  >Safe Withdrawal Rate</label
                >
                <div class="col">
                  <div class="input-group">
                    <input
                      type="number"
                      class="form-control"
                      id="safeWithdrawalRatePercentage"
                      formControlName="safeWithdrawalRatePercentage"
                      step="0.01"
                    />
                    <div class="input-group-append">
                      <div class="input-group-text">%</div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="row mb-3">
                <div class="col">
                  <small
                    >"The rate that you can withdraw from your portfolio every
                    year that ensures you have a high probability of never
                    running out of money." -
                    <a
                      target="_blank"
                      href="https://www.madfientist.com/safe-withdrawal-rate/"
                      >Mad Fientist
                      <fa-icon
                        [icon]="['fas', 'external-link-square-alt']"
                        size="sm"
                      ></fa-icon>
                    </a>
                  </small>
                  <div>
                    <small>
                      <a
                        target="_blank"
                        href="http://www.mrmoneymustache.com/2012/05/29/how-much-do-i-need-for-retirement/"
                        >4% - Mr. Money Mustache
                        <fa-icon
                          [icon]="['fas', 'external-link-square-alt']"
                          size="sm"
                        ></fa-icon>
                      </a>
                      |
                      <a
                        target="_blank"
                        href="https://web.archive.org/web/20181009165106/http://media.morningstar.com/uk/MEDIA/Comprehensive_update_on_the_Safe_Withdrawal_Rate.pdf"
                        >SWR in the UK - Morningstar
                        <fa-icon
                          [icon]="['fas', 'external-link-square-alt']"
                          size="sm"
                        ></fa-icon>
                      </a>
                    </small>
                  </div>
                </div>
              </div>
            </div>
            <div class="form-group">
              <div class="row">
                <label
                  for="expectedExternalAnnualContributions"
                  class="col-sm-12 col-md-5 col-form-label"
                  >Expected External Annual Contributions</label
                >
                <div class="col">
                  <div class="input-group">
                    <input
                      type="number"
                      class="form-control"
                      id="expectedExternalAnnualContributions"
                      formControlName="expectedExternalAnnualContributions"
                      step="100"
                    />
                  </div>
                </div>
              </div>
              <div class="row mb-3">
                <div class="col">
                  <small
                    >Annual income expected in retirement from external sources
                    (e.g., pension, social security). This reduces your FI
                    target.</small
                  >
                </div>
              </div>
            </div>
            <div class="form-group">
              <div class="row">
                <label
                  for="additionalLumpSumNeeded"
                  class="col-sm-12 col-md-5 col-form-label"
                  >Additional Lump Sum Needed</label
                >
                <div class="col">
                  <div class="input-group">
                    <input
                      type="number"
                      class="form-control"
                      id="additionalLumpSumNeeded"
                      formControlName="additionalLumpSumNeeded"
                      step="1000"
                    />
                  </div>
                </div>
              </div>
              <div class="row mb-3">
                <div class="col">
                  <small
                    >One-time amount needed at retirement (e.g., pay off
                    mortgage, major purchase). This increases your FI
                    target.</small
                  >
                </div>
              </div>
            </div>
            <div class="form-group">
              <div class="row">
                <label
                  for="expectedAnnualGrowthRate"
                  class="col-sm-12 col-md-5 col-form-label"
                  >Expected Annual Rate of Return</label
                >
                <div class="col">
                  <div class="input-group">
                    <input
                      type="number"
                      class="form-control"
                      id="expectedAnnualGrowthRate"
                      formControlName="expectedAnnualGrowthRate"
                      step="0.01"
                      aria-describedby="expectedAnnualGrowthRateHelp"
                    />
                    <div class="input-group-append">
                      <div class="input-group-text">%</div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="row mb-3">
                <div class="col">
                  <small>
                    <a
                      target="_blank"
                      href="http://www.mrmoneymustache.com/2011/06/06/dude-wheres-my-7-investment-return/"
                      >7% - Mr. Money Mustache
                      <fa-icon
                        [icon]="['fas', 'external-link-square-alt']"
                        size="sm"
                      ></fa-icon>
                    </a>
                  </small>
                </div>
              </div>
              <div class="row mb-3">
                <label
                  for="includeHiddenYnabCategories"
                  class="col-sm-12 col-md-5 col-form-label d-flex align-items-center"
                  >Include Hidden Categories</label
                >
                <div class="col">
                  <div class="form-check d-flex align-items-center">
                    <input
                      type="checkbox"
                      class="form-check-input"
                      id="includeHiddenYnabCategories"
                      formControlName="includeHiddenYnabCategories"
                      aria-describedby="includeHiddenYnabCategoriesHelp"
                    />
                  </div>
                </div>
              </div>
              <div class="row mb-3">
                <label for="birthdate" class="col-sm-12 col-md-5 col-form-label"
                  >Birthdate</label
                >
                <div class="col">
                  <div class="input-group">
                    <input
                      class="form-control"
                      id="ngBirthDate"
                      formControlName="birthdate"
                      ngbDatepicker
                      #d="ngbDatepicker"
                      [minDate]="{ year: 1925, month: 1, day: 1 }"
                      placeholder="yyyy-mm-dd"
                      [readonly]="false"
                    />
                    <div class="input-group-append">
                      <button
                        class="btn btn-outline-secondary bi bi-calendar3"
                        (click)="d.toggle()"
                        type="button"
                      ></button>
                    </div>
                  </div>
                </div>
              </div>
              <div class="row">
                <label
                  for="targetRetirementAge"
                  class="col-sm-12 col-md-5 col-form-label"
                  >Target Retirement Age</label
                >
                <div class="col">
                  <div class="input-group">
                    <input
                      type="number"
                      class="form-control"
                      id="targetRetirementAge"
                      formControlName="targetRetirementAge"
                      min="18"
                      max="120"
                      step="1"
                    />
                  </div>
                </div>
              </div>
              <div class="row mb-3">
                <div class="col">
                  <small
                    >Used for Coast FI calculation. Coast FI is the amount
                    needed today where investment growth alone reaches your FI
                    number by your target retirement age.</small
                  >
                  <br />
                  <small>
                    <a
                      target="_blank"
                      href="https://www.financialsamurai.com/what-is-coast-fire-financial-independence-retire-early/"
                      >What Is Coast FIRE And Is It The Right Retirement Path For You? - Financial Samurai
                      <fa-icon
                        [icon]="['fas', 'external-link-square-alt']"
                        size="sm"
                      ></fa-icon>
                    </a>
                  </small>
                </div>
              </div>
            </div>
          </ng-template>
        </div>
      </div>
    </div>
    <div ngbAccordionItem id="pNetWorth">
      <h2 ngbAccordionHeader>
        <button ngbAccordionButton>
          <span class="float-start">Starting Portfolio</span>
          <span class="ms-auto">
            {{ netWorth | currency : currencyIsoCode }}
          </span>
        </button>
      </h2>
      <div ngbAccordionCollapse>
        <div ngbAccordionBody>
          <ng-template>
            <div class="row mb-3">
              <table class="table col-12">
                <thead class="thead-sum">
                  <tr>
                    <th>Starting Balance</th>
                    <td>{{ ynabNetWorth | currency : currencyIsoCode }}</td>
                    <td>{{ netWorth | currency : currencyIsoCode }}</td>
                  </tr>
                  <tr>
                    <td colspan="3">
                      <small
                        >The initial amount to compound with the expected annual
                        rate of return</small
                      >
                    </td>
                  </tr>
                </thead>
                <thead class="table-dark">
                  <tr>
                    <th>Account</th>
                    <th>YNAB Balance</th>
                    <th>Balance</th>
                  </tr>
                </thead>
                <tbody formArrayName="accounts">
                  <tr
                    *ngFor="let account of accounts.controls; let i = index"
                    [formGroupName]="i"
                  >
                    <td>{{ account.value.name }}</td>
                    <td>
                      {{
                        account.value.ynabBalance | currency : currencyIsoCode
                      }}
                    </td>
                    <td>
                      <input
                        class="form-control"
                        formControlName="balance"
                        type="number"
                      />
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="row">
              <div class="col-12">
                <h4>How we pull these numbers from YNAB</h4>
                <p>
                  By default, all Asset (e.g. Investment) accounts are summed.
                </p>
                <p>
                  To override the balance add
                  <code>BR4 + <i>amount</i></code> (e.g.
                  <code>BR4 + 1000</code>) to the Account Notes of that account.
                </p>
                <p>
                  Or, add <code>BR4 +</code> without an amount to override with
                  the YNAB balance regardless of the account type.
                </p>
                <p>
                  <strong>Scheduled Changes:</strong> You can specify future changes using a date prefix.
                  For example, <code>BR4 + 50000 BR4 2025-06 + 75000</code> starts at $50,000 and
                  increases to $75,000 in June 2025.
                </p>
              </div>
            </div>
          </ng-template>
        </div>
      </div>
    </div>
    <div ngbAccordionItem id="pContributions">
      <h2 ngbAccordionHeader>
        <button ngbAccordionButton>
          <span class="float-start">Contributions</span>
          <span class="ms-auto text-end">
            {{ budgetForm.value.monthlyContribution * 12 | currency : currencyIsoCode }} per year
            <small class="opacity-75 d-block mt-1">{{ budgetForm.value.monthlyContribution | currency : currencyIsoCode }} per month</small>
          </span>
        </button>
      </h2>

      <div ngbAccordionCollapse>
        <div ngbAccordionBody>
          <ng-template>
            <div class="form-group row mb-3">
              <label
                for="monthlyContribution"
                class="col-sm-12 col-md-5 col-form-label"
                >Monthly Investment Contribution</label
              >
              <div class="col">
                <input
                  type="number"
                  class="form-control"
                  id="monthlyContribution"
                  formControlName="monthlyContribution"
                  step="100"
                />
              </div>
              <!-- <div class="col-sm-1">
              <button type="button" class="btn btn-link" (click)="displayContributionInfo = !displayContributionInfo">
                <fa-icon [icon]="['fas', 'info-circle']"></fa-icon>
              </button>
            </div> -->
            </div>
            <div
              class="row"
              *ngIf="contributionCategories && contributionCategories.length"
            >
              <table class="table col-12">
                <thead class="table-dark">
                  <tr>
                    <th>Category Name</th>
                    <th>Contribution</th>
                  </tr>
                </thead>
                <tbody>
                  <ng-container *ngFor="let category of contributionCategories">
                    <tr *ngIf="!category.hidden">
                      <td>{{ category.name }}</td>
                      <td>
                        <span
                          ngbPopover="Min:  {{
                            category.info.min.value | currency : currencyIsoCode
                          }} Max:  {{
                            category.info.max.value | currency : currencyIsoCode
                          }} Mean: {{
                            category.info.mean | currency : currencyIsoCode
                          }} "
                          triggers="mouseenter:mouseleave"
                        >
                          {{ category.value | currency : currencyIsoCode }}
                        </span>
                      </td>
                    </tr>
                  </ng-container>
                </tbody>
              </table>
            </div>
            <div *ngIf="displayContributionInfo">
              <div class="row">
                <div class="col-12">
                  <h4>How we pull these numbers from YNAB</h4>
                  <p>
                    Any category groups containing the following text are
                    automatically counted as contributions:
                  </p>
                  <ul>
                    <li>Financial Independence</li>
                    <li>Investments</li>
                    <li>Retirement</li>
                    <li>FIRE</li>
                    <li>üìà</li>
                    <li>üî•</li>
                  </ul>
                  <p>
                    <span
                      >If you would like to override the budgeted amount add
                      <code>BR4 + <i>amount</i></code></span
                    >
                    (e.g. <code>BR4 + 1000</code>) to the notes of that
                    category. This is useful for including contributions to
                    employer accounts that aren't budgeted.
                  </p>
                  <p>
                    Add <code>BR4 +</code> without an amount to override with
                    the YNAB balance as a contribution regardless of the
                    category group name.
                  </p>
                  <p>
                    <strong>Scheduled Changes:</strong> Use a date prefix to schedule
                    contribution changes. For example, <code>BR4 + 500 BR4 2025-06 + 1000</code>
                    contributes $500 now and increases to $1,000 starting June 2025.
                    This is useful for planning increased savings after a debt is paid off.
                  </p>
                </div>
              </div>
              <div class="row">
                <div class="col-12">
                  <img
                    src="assets/images/FiCategory.png"
                    class="img-fluid"
                    alt="Category Image"
                  />
                </div>
                <div class="col-12">
                  <img
                    src="assets/images/ContributionNotes.png"
                    class="img-fluid"
                    alt="Contribution Notes"
                  />
                </div>
                <div class="col-12">
                  <p class="small">
                    (When editing a category's Notes, use
                    <kbd>shift + enter</kbd> or <kbd>shift + return</kbd> to
                    create a new line.)
                  </p>
                </div>
              </div>
              <div class="row">
                <div class="col-12">
                  <p>
                    As another option, Accounts can log a monthly contribution
                    by adding <code>BR4 +m <i>amount</i></code> (e.g.
                    <code>BR4 +m 100</code>) to the Account Notes.
                  </p>
                </div>
              </div>
            </div>
          </ng-template>
        </div>
      </div>
    </div>
    <div ngbAccordionItem id="pExpenses">
      <h2 ngbAccordionHeader>
        <button ngbAccordionButton>
          <span class="float-start">Expenses</span>
          <span class="ms-auto text-end">
            {{ expenses.fi.annual | currency : currencyIsoCode }} per year
            <small class="opacity-75 d-block mt-1">{{ expenses.fi.monthly | currency : currencyIsoCode }} per month</small>
          </span>
        </button>
      </h2>
      <div ngbAccordionCollapse>
        <div ngbAccordionBody>
          <ng-template>
            <div class="row">
              <table class="table table-sm col-12 expenses">
                <thead class="table-dark">
                  <tr>
                    <th>Calculated</th>
                    <th>YNAB<span class="mobile-currency"> ({{ currencyIsoCode }})</span></th>
                    <th
                      placement="top"
                      triggers="click:blur hover"
                      container="body"
                      ngbTooltip="FI budget includes all expenses to maintain your current lifestyle."
                    >
                      FI<span class="mobile-currency"> ({{ currencyIsoCode }})</span> &nbsp;
                      <fa-icon [icon]="['fas', 'info-circle']"></fa-icon>
                    </th>
                    <th
                      placement="top"
                      triggers="click:blur hover"
                      container="body"
                      ngbTooltip="Lean FI budget includes all expenses to just get by. Think FI but without any fun."
                    >
                      Lean FI<span class="mobile-currency"> ({{ currencyIsoCode }})</span> &nbsp;
                      <fa-icon [icon]="['fas', 'info-circle']"></fa-icon>
                    </th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <th>Monthly Expenses</th>
                    <td>
                      <span class="desktop-only">{{ expenses.ynab.monthly | currency : currencyIsoCode }}</span>
                      <span class="mobile-only">{{ expenses.ynab.monthly | number : '1.0-0' }}</span>
                    </td>
                    <td>
                      <span class="desktop-only">{{ expenses.fi.monthly | currency : currencyIsoCode }}</span>
                      <span class="mobile-only">{{ expenses.fi.monthly | number : '1.0-0' }}</span>
                    </td>
                    <td>
                      <span class="desktop-only">{{ expenses.leanFi.monthly | currency : currencyIsoCode }}</span>
                      <span class="mobile-only">{{ expenses.leanFi.monthly | number : '1.0-0' }}</span>
                    </td>
                  </tr>
                  <tr>
                    <th>Estimated Annual Expenses</th>
                    <td>
                      <span class="desktop-only">{{ expenses.ynab.annual | currency : currencyIsoCode }}</span>
                      <span class="mobile-only">{{ expenses.ynab.annual | number : '1.0-0' }}</span>
                    </td>
                    <td>
                      <span class="desktop-only">{{ expenses.fi.annual | currency : currencyIsoCode }}</span>
                      <span class="mobile-only">{{ expenses.fi.annual | number : '1.0-0' }}</span>
                    </td>
                    <td>
                      <span class="desktop-only">{{ expenses.leanFi.annual | currency : currencyIsoCode }}</span>
                      <span class="mobile-only">{{ expenses.leanFi.annual | number : '1.0-0' }}</span>
                    </td>
                  </tr>
                </tbody>
                <thead class="table-dark">
                  <tr>
                    <th>Category</th>
                    <th>YNAB Budget<span class="mobile-currency"> ({{ currencyIsoCode }})</span></th>
                    <th>FI Budget<span class="mobile-currency"> ({{ currencyIsoCode }})</span></th>
                    <th>Lean FI Budget<span class="mobile-currency"> ({{ currencyIsoCode }})</span></th>
                  </tr>
                </thead>
                <tbody formArrayName="categoryGroups">
                  <ng-container
                    *ngFor="
                      let categoryGroup of categoryGroups.controls;
                      let i = index
                    "
                    [formGroupName]="i"
                  >
                    <tr class="table-secondary">
                      <th colspan="4" class="">
                        {{ categoryGroup.value.name }}
                      </th>
                    </tr>
                    <ng-container formArrayName="categories">
                      <ng-container
                        *ngFor="
                          let category of categoryGroup.get('categories')
                            .controls;
                          let j = index
                        "
                        [formGroupName]="j"
                      >
                        <tr *ngIf="!category.value.hidden">
                          <td>
                            {{ category.value.name }}
                          </td>
                          <td>
                            <span
                              ngbPopover="Min:  {{
                                category.value.info.min.value
                                  | currency : currencyIsoCode
                              }} Max:  {{
                                category.value.info.max.value
                                  | currency : currencyIsoCode
                              }} Mean: {{
                                category.value.info.mean
                                  | currency : currencyIsoCode
                              }} "
                              triggers="mouseenter:mouseleave"
                            >
                              <span class="desktop-only">{{
                                category.value.retrievedBudgeted
                                  | currency : currencyIsoCode
                              }}</span>
                              <span class="mobile-only">{{
                                category.value.retrievedBudgeted
                                  | number : '1.0-0'
                              }}</span>
                            </span>
                          </td>
                          <td>
                            <input
                              class="form-control form-control-sm"
                              formControlName="fiBudget"
                              type="number"
                            />
                          </td>
                          <td>
                            <input
                              class="form-control form-control-sm"
                              formControlName="leanFiBudget"
                              type="number"
                            />
                          </td>
                        </tr>
                      </ng-container>
                    </ng-container>
                  </ng-container>
                </tbody>
              </table>
            </div>
            <div class="row">
              <div class="col-12">
                <h4>How we pull these numbers from YNAB</h4>
                <p>
                  The following category groups are automatically budgeted to 0
                  for Financial Independence:
                </p>
                <ul>
                  <li>
                    All defined Financial Independence category groups - You're
                    already FI, no need to keep saving!
                  </li>
                  <li>
                    Debt Payments - For simplicity, lets assume this is all paid
                    off
                  </li>
                  <li>
                    Credit Card Payments - For simplicity, lets assume you pay
                    this off every month
                  </li>
                  <li>Any category groups with names containing üìâ or üîï</li>
                </ul>
                <p>
                  In addition, the following category groups are automatically
                  budgeted to 0 for Lean Financial Independence:
                </p>
                <ul>
                  <li>
                    Just For Fun - Lean FI is all about saying you could just
                    make it by
                  </li>
                  <li>
                    Quality of Life Goals - Theoretically, these goals aren't
                    required to live a bland but financially independent life
                  </li>
                  <li>Any category groups with names containing üå§Ô∏è</li>
                </ul>
                <p>
                  Finally, any category groups with names containing üëª are
                  completely ignored from the software
                </p>
                <p>
                  If you would like to override the FI Budget value add
                  <code>BR4 FI <i>amount</i></code> (e.g.
                  <code>BR4 FI 1100</code>) to the notes of that category.
                </p>
                <p>
                  To further override the Lean FI value, use
                  <code>BR4 LFI <i>amount</i></code> (e.g.
                  <code>BR4 LFI 400</code>)
                </p>
                <p>
                  Add <code>BR4 FI</code> or <code>BR4 LFI</code> without an
                  amount to override with the YNAB balance regardless of the
                  category group name.
                </p>
                <p>
                  <strong>Scheduled Changes:</strong> Use a date prefix to schedule
                  expense changes. For example, <code>BR4 FI 500 BR4 2030-01 FI 0</code>
                  budgets $500/month for FI expenses until January 2030, then drops to $0.
                  This is perfect for expenses that will end in the future, like a mortgage
                  or car payment.
                </p>
              </div>
            </div>
            <div class="row">
              <div class="col-12">
                <img
                  src="assets/images/HousingCategory.png"
                  class="img-fluid"
                  alt="Housing Category Image"
                />
              </div>
              <div class="col-12">
                <img
                  src="assets/images/HousingNotes.png"
                  class="img-fluid"
                  alt="Editing the notes for the Mortgage category"
                />
              </div>
              <div class="col-12">
                <p class="small">
                  (When editing a category's Notes, use
                  <kbd>shift + enter</kbd> or <kbd>shift + return</kbd> to
                  create a new line.)
                </p>
              </div>
            </div>
          </ng-template>
        </div>
      </div>
    </div>
    <!-- Overwritten Categories Accordion -->
    <div ngbAccordionItem id="pOverwrittenCategories" *ngIf="baselineOverrides.length > 0">
      <h2 ngbAccordionHeader>
        <button ngbAccordionButton>
          <span class="float-start">Overwritten Categories</span>
          <span class="ms-auto">
            {{ getEnabledBaselineCount() }} of {{ baselineOverrides.length }}
          </span>
        </button>
      </h2>
      <div ngbAccordionCollapse>
        <div ngbAccordionBody>
          <ng-template>
            <!-- Master toggle -->
            <div class="form-check mb-3">
              <input
                type="checkbox"
                class="form-check-input"
                id="baselineOverridesEnabled"
                [(ngModel)]="baselineOverridesEnabled"
                [ngModelOptions]="{standalone: true}"
                (change)="toggleAllBaselineOverrides(baselineOverridesEnabled)"
              />
              <label class="form-check-label" for="baselineOverridesEnabled"
                >Apply BR4 overrides to calculations</label
              >
            </div>

            <!-- Contributions -->
            <div
              *ngIf="getBaselineOverridesByType('contribution').length > 0"
              class="mb-3"
            >
              <h6>Contributions</h6>
              <div
                *ngFor="let override of getBaselineOverridesByType('contribution')"
                class="form-check"
              >
                <input
                  type="checkbox"
                  class="form-check-input"
                  [id]="'baseline-' + override.id"
                  [(ngModel)]="override.enabled"
                  [ngModelOptions]="{standalone: true}"
                  [disabled]="!baselineOverridesEnabled"
                  (change)="toggleBaselineOverride(override)"
                />
                <label
                  class="form-check-label"
                  [for]="'baseline-' + override.id"
                  [class.text-muted]="!baselineOverridesEnabled"
                >
                  {{ override.categoryName }}:
                  {{ override.originalValue | currency : currencyIsoCode }} ‚Üí
                  {{ override.overriddenValue | currency : currencyIsoCode }}
                </label>
              </div>
            </div>

            <!-- FI Expenses -->
            <div
              *ngIf="getBaselineOverridesByType('fiBudget').length > 0"
              class="mb-3"
            >
              <h6>FI Expenses</h6>
              <div
                *ngFor="let override of getBaselineOverridesByType('fiBudget')"
                class="form-check"
              >
                <input
                  type="checkbox"
                  class="form-check-input"
                  [id]="'baseline-' + override.id"
                  [(ngModel)]="override.enabled"
                  [ngModelOptions]="{standalone: true}"
                  [disabled]="!baselineOverridesEnabled"
                  (change)="toggleBaselineOverride(override)"
                />
                <label
                  class="form-check-label"
                  [for]="'baseline-' + override.id"
                  [class.text-muted]="!baselineOverridesEnabled"
                >
                  {{ override.categoryName }}:
                  {{ override.originalValue | currency : currencyIsoCode }} ‚Üí
                  {{ override.overriddenValue | currency : currencyIsoCode }}
                </label>
              </div>
            </div>

            <!-- Lean FI Expenses -->
            <div
              *ngIf="getBaselineOverridesByType('leanFiBudget').length > 0"
              class="mb-3"
            >
              <h6>Lean FI Expenses</h6>
              <div
                *ngFor="let override of getBaselineOverridesByType('leanFiBudget')"
                class="form-check"
              >
                <input
                  type="checkbox"
                  class="form-check-input"
                  [id]="'baseline-' + override.id"
                  [(ngModel)]="override.enabled"
                  [ngModelOptions]="{standalone: true}"
                  [disabled]="!baselineOverridesEnabled"
                  (change)="toggleBaselineOverride(override)"
                />
                <label
                  class="form-check-label"
                  [for]="'baseline-' + override.id"
                  [class.text-muted]="!baselineOverridesEnabled"
                >
                  {{ override.categoryName }}:
                  {{ override.originalValue | currency : currencyIsoCode }} ‚Üí
                  {{ override.overriddenValue | currency : currencyIsoCode }}
                </label>
              </div>
            </div>

            <!-- Starting Portfolio (accounts) -->
            <div
              *ngIf="getBaselineOverridesByType('startingPortfolio').length > 0"
              class="mb-3"
            >
              <h6>Starting Portfolio</h6>
              <div
                *ngFor="let override of getBaselineOverridesByType('startingPortfolio')"
                class="form-check"
              >
                <input
                  type="checkbox"
                  class="form-check-input"
                  [id]="'baseline-' + override.id"
                  [(ngModel)]="override.enabled"
                  [ngModelOptions]="{standalone: true}"
                  [disabled]="!baselineOverridesEnabled"
                  (change)="toggleBaselineOverride(override)"
                />
                <label
                  class="form-check-label"
                  [for]="'baseline-' + override.id"
                  [class.text-muted]="!baselineOverridesEnabled"
                >
                  {{ override.categoryName }}:
                  {{ override.originalValue | currency : currencyIsoCode }} ‚Üí
                  {{ override.overriddenValue | currency : currencyIsoCode }}
                </label>
              </div>
            </div>

            <!-- Monthly Contributions (accounts) -->
            <div
              *ngIf="getBaselineOverridesByType('monthlyContribution').length > 0"
              class="mb-3"
            >
              <h6>Monthly Contributions</h6>
              <div
                *ngFor="let override of getBaselineOverridesByType('monthlyContribution')"
                class="form-check"
              >
                <input
                  type="checkbox"
                  class="form-check-input"
                  [id]="'baseline-' + override.id"
                  [(ngModel)]="override.enabled"
                  [ngModelOptions]="{standalone: true}"
                  [disabled]="!baselineOverridesEnabled"
                  (change)="toggleBaselineOverride(override)"
                />
                <label
                  class="form-check-label"
                  [for]="'baseline-' + override.id"
                  [class.text-muted]="!baselineOverridesEnabled"
                >
                  {{ override.categoryName }}:
                  {{ override.originalValue | currency : currencyIsoCode }} ‚Üí
                  {{ override.overriddenValue | currency : currencyIsoCode }}
                </label>
              </div>
            </div>

            <!-- Help text -->
            <div class="row mt-3">
              <div class="col-12">
                <p class="mb-2"><strong>About overwritten categories</strong></p>
                <p class="mb-1">
                  These categories have customized values via BR4 commands in their YNAB notes.
                  Toggle off to temporarily revert to original YNAB values.
                </p>
              </div>
            </div>
          </ng-template>
        </div>
      </div>
    </div>
    <div ngbAccordionItem id="pScheduledChanges" *ngIf="scheduledChanges.length > 0">
      <h2 ngbAccordionHeader>
        <button ngbAccordionButton>
          <span class="float-start">Scheduled Changes</span>
          <span class="ms-auto">{{ getEnabledScheduleCount() }} of {{ scheduledChanges.length }}</span>
        </button>
      </h2>
      <div ngbAccordionCollapse>
        <div ngbAccordionBody>
          <ng-template>
            <!-- Master toggle -->
            <div class="form-check mb-3">
              <input
                type="checkbox"
                class="form-check-input"
                id="scheduledChangesEnabled"
                [(ngModel)]="scheduledChangesEnabled"
                [ngModelOptions]="{standalone: true}"
                (change)="toggleAllScheduledChanges(scheduledChangesEnabled)"
              />
              <label class="form-check-label" for="scheduledChangesEnabled"
                >Apply scheduled changes to forecast</label
              >
            </div>

            <!-- Contribution changes -->
            <div
              *ngIf="getScheduledChangesByType('contribution').length > 0"
              class="mb-3"
            >
              <h6>Contributions</h6>
              <div
                *ngFor="let change of getScheduledChangesByType('contribution')"
                class="form-check"
              >
                <input
                  type="checkbox"
                  class="form-check-input"
                  [id]="'scheduled-' + change.id"
                  [(ngModel)]="change.enabled"
                  [ngModelOptions]="{standalone: true}"
                  [disabled]="!scheduledChangesEnabled"
                  (change)="toggleScheduledChange(change)"
                />
                <label
                  class="form-check-label"
                  [for]="'scheduled-' + change.id"
                  [class.text-muted]="!scheduledChangesEnabled"
                >
                  {{ change.categoryName }}:
                  {{ change.baselineValue | currency : currencyIsoCode }} ‚Üí
                  {{ change.scheduledValue | currency : currencyIsoCode }}
                  starting {{ change.effectiveDate }}
                </label>
              </div>
            </div>

            <!-- FI Expense changes -->
            <div
              *ngIf="getScheduledChangesByType('fiBudget').length > 0"
              class="mb-3"
            >
              <h6>FI Expenses</h6>
              <div
                *ngFor="let change of getScheduledChangesByType('fiBudget')"
                class="form-check"
              >
                <input
                  type="checkbox"
                  class="form-check-input"
                  [id]="'scheduled-' + change.id"
                  [(ngModel)]="change.enabled"
                  [ngModelOptions]="{standalone: true}"
                  [disabled]="!scheduledChangesEnabled"
                  (change)="toggleScheduledChange(change)"
                />
                <label
                  class="form-check-label"
                  [for]="'scheduled-' + change.id"
                  [class.text-muted]="!scheduledChangesEnabled"
                >
                  {{ change.categoryName }}:
                  {{ change.baselineValue | currency : currencyIsoCode }} ‚Üí
                  {{ change.scheduledValue | currency : currencyIsoCode }}
                  starting {{ change.effectiveDate }}
                </label>
              </div>
            </div>

            <!-- Lean FI Expense changes -->
            <div
              *ngIf="getScheduledChangesByType('leanFiBudget').length > 0"
              class="mb-3"
            >
              <h6>Lean FI Expenses</h6>
              <div
                *ngFor="let change of getScheduledChangesByType('leanFiBudget')"
                class="form-check"
              >
                <input
                  type="checkbox"
                  class="form-check-input"
                  [id]="'scheduled-' + change.id"
                  [(ngModel)]="change.enabled"
                  [ngModelOptions]="{standalone: true}"
                  [disabled]="!scheduledChangesEnabled"
                  (change)="toggleScheduledChange(change)"
                />
                <label
                  class="form-check-label"
                  [for]="'scheduled-' + change.id"
                  [class.text-muted]="!scheduledChangesEnabled"
                >
                  {{ change.categoryName }}:
                  {{ change.baselineValue | currency : currencyIsoCode }} ‚Üí
                  {{ change.scheduledValue | currency : currencyIsoCode }}
                  starting {{ change.effectiveDate }}
                </label>
              </div>
            </div>

            <div class="row mt-3">
              <div class="col-12">
                <p class="mb-2"><strong>How to add scheduled changes</strong></p>
                <p class="mb-1">
                  Add a date prefix to any BR4 note in YNAB category notes:
                </p>
                <ul class="small mb-2">
                  <li>
                    <strong>Contributions:</strong> <code>BR4 + 500 BR4 2027-01 + 1000</code>
                    ‚Äî contributes $500/month now, increases to $1,000 starting Jan 2027
                  </li>
                  <li>
                    <strong>FI Expenses:</strong> <code>BR4 FI 800 BR4 2029-07 FI 0</code>
                    ‚Äî $800/month FI expense now, drops to $0 when paid off in Jul 2029
                  </li>
                  <li>
                    <strong>Lean FI Expenses:</strong> <code>BR4 LFI 400 BR4 2035-01 LFI 0</code>
                    ‚Äî $400/month Lean FI expense, ends Jan 2035
                  </li>
                </ul>
                <small class="text-muted">
                  The date format is <code>YYYY-MM</code>. Multiple scheduled changes can be added to a single category.
                </small>
              </div>
            </div>
          </ng-template>
        </div>
      </div>
    </div>
  </div>
</form>
